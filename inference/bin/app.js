#!/usr/bin/env node
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const aws_cdk_lib_1 = require("aws-cdk-lib");
const fs = require("fs");
const js_yaml_1 = require("js-yaml");
const path = require("path");
require("source-map-support/register");
const inference_pipeline_1 = require("../lib/stacks/inference-pipeline");
const cdk_nag_1 = require("cdk-nag");
const app = new aws_cdk_lib_1.App();
function getConfig() {
    let configYaml = (0, js_yaml_1.load)(fs.readFileSync(path.resolve("./config.yaml"), "utf8"));
    let repoConfigYaml = (0, js_yaml_1.load)(fs.readFileSync(path.resolve("../repo_config.yaml"), "utf8"));
    let appConfig = {
        repoType: repoConfigYaml['repoType'],
        repoName: repoConfigYaml['repoName'],
        branchName: repoConfigYaml['branchName'],
        githubConnectionArn: repoConfigYaml['githubConnectionArn'],
        githubRepoOwner: repoConfigYaml['githubRepoOwner'],
        pipelinePrefix: configYaml['pipelineAssetsPrefix'],
        assetsBucket: aws_cdk_lib_1.Fn.importValue('mlopsDataBucket'),
        ggProps: {
            thingIotPolicyName: configYaml['gg']['thingIotPolicyName'],
            tokenExchangeRoleAlias: configYaml['gg']['tokenExchangeRoleAlias'],
            allowAssumeTokenExchangeRolePolicyName: configYaml['gg']['allowAssumeTokenExchangeRolePolicyName'],
            iotThingName: configYaml['gg']['iotThingName']
        },
        deploymentProps: {
            smModelPackageGroupName: aws_cdk_lib_1.Fn.importValue('mlopsModelPackageGroup'),
            ggModelComponentName: configYaml['edgeDeploymentOrchestration']['ggModelComponentName'],
            ggInferenceComponentName: configYaml['edgeDeploymentOrchestration']['ggInferenceComponentName']
        }
    };
    return appConfig;
}
async function Main() {
    const stack = new inference_pipeline_1.InferenceCdkPipeline(app, 'MLOps-Inference-Infra-Stack', getConfig());
    addSecurityChecks(app, [stack]);
    app.synth();
}
function addSecurityChecks(app, stacks) {
    for (let stack in stacks) {
        cdk_nag_1.NagSuppressions.addStackSuppressions(stacks[stack], [{ id: "AwsSolutions-IAM4", reason: "Suppress disallowed use of managed policies for increased simplicity as this is a sample. Scope down in production!" }]);
        cdk_nag_1.NagSuppressions.addStackSuppressions(stacks[stack], [{ id: "AwsSolutions-IAM5", reason: "Suppress disallowed use of wildcards in IAM policies for increased simplicity as this is a sample. Scope down in production!" }]);
        cdk_nag_1.NagSuppressions.addStackSuppressions(stacks[stack], [{ id: "AwsSolutions-L1", reason: "Using fixed python version for lambda functions as sample needs to be stable" }]);
        cdk_nag_1.NagSuppressions.addStackSuppressions(stacks[stack], [{ id: "AwsSolutions-CB3", reason: "Suppress warning for use of privileged mode for codebuild, as this is required for docker image build" }]);
        cdk_nag_1.NagSuppressions.addStackSuppressions(stacks[stack], [{ id: "AwsSolutions-CB4", reason: "Suppress required use of KMS for CodeBuild as it incurs additional cost. Consider using KMS for Codebuild in production" }]);
    }
    aws_cdk_lib_1.Aspects.of(app).add(new cdk_nag_1.AwsSolutionsChecks({ verbose: true }));
}
Main();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYXBwLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLDZDQUFnRTtBQUNoRSx5QkFBeUI7QUFDekIscUNBQStCO0FBQy9CLDZCQUE2QjtBQUU3Qix1Q0FBcUM7QUFDckMseUVBQXdFO0FBQ3hFLHFDQUE4RDtBQUU5RCxNQUFNLEdBQUcsR0FBRyxJQUFJLGlCQUFHLEVBQUUsQ0FBQztBQXVCdEIsU0FBUyxTQUFTO0lBQ2hCLElBQUksVUFBVSxHQUFRLElBQUEsY0FBSSxFQUFDLEVBQUUsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxlQUFlLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDO0lBQ25GLElBQUksY0FBYyxHQUFRLElBQUEsY0FBSSxFQUFDLEVBQUUsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxxQkFBcUIsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUM7SUFDN0YsSUFBSSxTQUFTLEdBQWM7UUFDekIsUUFBUSxFQUFFLGNBQWMsQ0FBQyxVQUFVLENBQUM7UUFDcEMsUUFBUSxFQUFFLGNBQWMsQ0FBQyxVQUFVLENBQUM7UUFDcEMsVUFBVSxFQUFFLGNBQWMsQ0FBQyxZQUFZLENBQUM7UUFDeEMsbUJBQW1CLEVBQUUsY0FBYyxDQUFDLHFCQUFxQixDQUFDO1FBQzFELGVBQWUsRUFBRSxjQUFjLENBQUMsaUJBQWlCLENBQUM7UUFDbEQsY0FBYyxFQUFFLFVBQVUsQ0FBQyxzQkFBc0IsQ0FBQztRQUNsRCxZQUFZLEVBQUUsZ0JBQUUsQ0FBQyxXQUFXLENBQUMsaUJBQWlCLENBQUM7UUFDL0MsT0FBTyxFQUFFO1lBQ1Asa0JBQWtCLEVBQUUsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDLG9CQUFvQixDQUFDO1lBQzFELHNCQUFzQixFQUFFLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyx3QkFBd0IsQ0FBQztZQUNsRSxzQ0FBc0MsRUFBRSxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUMsd0NBQXdDLENBQUM7WUFDbEcsWUFBWSxFQUFFLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxjQUFjLENBQUM7U0FDL0M7UUFDRCxlQUFlLEVBQUU7WUFDZix1QkFBdUIsRUFBRSxnQkFBRSxDQUFDLFdBQVcsQ0FBQyx3QkFBd0IsQ0FBQztZQUNqRSxvQkFBb0IsRUFBRSxVQUFVLENBQUMsNkJBQTZCLENBQUMsQ0FBQyxzQkFBc0IsQ0FBQztZQUN2Rix3QkFBd0IsRUFBRSxVQUFVLENBQUMsNkJBQTZCLENBQUMsQ0FBQywwQkFBMEIsQ0FBQztTQUNoRztLQUNGLENBQUE7SUFDRCxPQUFPLFNBQVMsQ0FBQztBQUNuQixDQUFDO0FBRUQsS0FBSyxVQUFVLElBQUk7SUFFakIsTUFBTSxLQUFLLEdBQUcsSUFBSSx5Q0FBb0IsQ0FBQyxHQUFHLEVBQUUsNkJBQTZCLEVBQUUsU0FBUyxFQUFFLENBQUMsQ0FBQztJQUV4RixpQkFBaUIsQ0FBQyxHQUFHLEVBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFBO0lBQzlCLEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQztBQUNkLENBQUM7QUFHRCxTQUFTLGlCQUFpQixDQUFDLEdBQU8sRUFBRSxNQUFlO0lBQ2pELEtBQUssSUFBSSxLQUFLLElBQUksTUFBTSxFQUFFO1FBQ3hCLHlCQUFlLENBQUMsb0JBQW9CLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFDLENBQUMsRUFBQyxFQUFFLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxFQUFFLHFIQUFxSCxFQUFFLENBQUMsQ0FBQyxDQUFBO1FBQy9NLHlCQUFlLENBQUMsb0JBQW9CLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFDLENBQUMsRUFBQyxFQUFFLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxFQUFFLDhIQUE4SCxFQUFFLENBQUMsQ0FBQyxDQUFBO1FBQ3hOLHlCQUFlLENBQUMsb0JBQW9CLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFDLENBQUMsRUFBQyxFQUFFLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxFQUFFLDhFQUE4RSxFQUFFLENBQUMsQ0FBQyxDQUFBO1FBQ3RLLHlCQUFlLENBQUMsb0JBQW9CLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFDLENBQUMsRUFBQyxFQUFFLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxFQUFFLHVHQUF1RyxFQUFFLENBQUMsQ0FBQyxDQUFBO1FBQ2hNLHlCQUFlLENBQUMsb0JBQW9CLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFDLENBQUMsRUFBQyxFQUFFLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxFQUFFLHlIQUF5SCxFQUFFLENBQUMsQ0FBQyxDQUFBO0tBQ25OO0lBQ0QscUJBQU8sQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLElBQUksNEJBQWtCLENBQUMsRUFBQyxPQUFPLEVBQUMsSUFBSSxFQUFDLENBQUMsQ0FBQyxDQUFDO0FBRTlELENBQUM7QUFDRCxJQUFJLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIiMhL3Vzci9iaW4vZW52IG5vZGVcbmltcG9ydCB7IEFwcCwgU3RhY2tQcm9wcyAsRm4sU3RhY2ssIEFzcGVjdHN9IGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcbmltcG9ydCB7IGxvYWQgfSBmcm9tIFwianMteWFtbFwiO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tIFwicGF0aFwiO1xuaW1wb3J0IHsgY29uZmlnIH0gZnJvbSAncHJvY2Vzcyc7XG5pbXBvcnQgJ3NvdXJjZS1tYXAtc3VwcG9ydC9yZWdpc3Rlcic7XG5pbXBvcnQgeyBJbmZlcmVuY2VDZGtQaXBlbGluZSB9IGZyb20gJy4uL2xpYi9zdGFja3MvaW5mZXJlbmNlLXBpcGVsaW5lJztcbmltcG9ydCB7IEF3c1NvbHV0aW9uc0NoZWNrcyAsIE5hZ1N1cHByZXNzaW9uc30gZnJvbSAnY2RrLW5hZyc7XG5cbmNvbnN0IGFwcCA9IG5ldyBBcHAoKTtcblxuZXhwb3J0IGludGVyZmFjZSBBcHBDb25maWcgZXh0ZW5kcyBTdGFja1Byb3BzIHtcbiAgcmVhZG9ubHkgcmVwb1R5cGU6IHN0cmluZztcbiAgcmVhZG9ubHkgcmVwb05hbWU6IHN0cmluZztcbiAgcmVhZG9ubHkgYnJhbmNoTmFtZTogc3RyaW5nO1xuICByZWFkb25seSBnaXRodWJDb25uZWN0aW9uQXJuOiBzdHJpbmc7XG4gIHJlYWRvbmx5IGdpdGh1YlJlcG9Pd25lcjogc3RyaW5nO1xuICByZWFkb25seSBwaXBlbGluZVByZWZpeDogc3RyaW5nO1xuICByZWFkb25seSBhc3NldHNCdWNrZXQ6IHN0cmluZztcbiAgcmVhZG9ubHkgZ2dQcm9wczoge1xuICAgIHJlYWRvbmx5IHRoaW5nSW90UG9saWN5TmFtZTpzdHJpbmdcbiAgICByZWFkb25seSB0b2tlbkV4Y2hhbmdlUm9sZUFsaWFzOnN0cmluZ1xuICAgIHJlYWRvbmx5IGFsbG93QXNzdW1lVG9rZW5FeGNoYW5nZVJvbGVQb2xpY3lOYW1lOnN0cmluZ1xuICAgIHJlYWRvbmx5IGlvdFRoaW5nTmFtZTpzdHJpbmdcbiAgfTtcbiAgcmVhZG9ubHkgZGVwbG95bWVudFByb3BzOiB7XG4gICAgcmVhZG9ubHkgc21Nb2RlbFBhY2thZ2VHcm91cE5hbWU6c3RyaW5nXG4gICAgcmVhZG9ubHkgZ2dNb2RlbENvbXBvbmVudE5hbWU6c3RyaW5nXG4gICAgcmVhZG9ubHkgZ2dJbmZlcmVuY2VDb21wb25lbnROYW1lOnN0cmluZ1xuICB9O1xufVxuXG5mdW5jdGlvbiBnZXRDb25maWcoKSB7XG4gIGxldCBjb25maWdZYW1sOiBhbnkgPSBsb2FkKGZzLnJlYWRGaWxlU3luYyhwYXRoLnJlc29sdmUoXCIuL2NvbmZpZy55YW1sXCIpLCBcInV0ZjhcIikpO1xuICBsZXQgcmVwb0NvbmZpZ1lhbWw6IGFueSA9IGxvYWQoZnMucmVhZEZpbGVTeW5jKHBhdGgucmVzb2x2ZShcIi4uL3JlcG9fY29uZmlnLnlhbWxcIiksIFwidXRmOFwiKSk7XG4gIGxldCBhcHBDb25maWc6IEFwcENvbmZpZyA9IHtcbiAgICByZXBvVHlwZTogcmVwb0NvbmZpZ1lhbWxbJ3JlcG9UeXBlJ10sXG4gICAgcmVwb05hbWU6IHJlcG9Db25maWdZYW1sWydyZXBvTmFtZSddLFxuICAgIGJyYW5jaE5hbWU6IHJlcG9Db25maWdZYW1sWydicmFuY2hOYW1lJ10sXG4gICAgZ2l0aHViQ29ubmVjdGlvbkFybjogcmVwb0NvbmZpZ1lhbWxbJ2dpdGh1YkNvbm5lY3Rpb25Bcm4nXSxcbiAgICBnaXRodWJSZXBvT3duZXI6IHJlcG9Db25maWdZYW1sWydnaXRodWJSZXBvT3duZXInXSxcbiAgICBwaXBlbGluZVByZWZpeDogY29uZmlnWWFtbFsncGlwZWxpbmVBc3NldHNQcmVmaXgnXSxcbiAgICBhc3NldHNCdWNrZXQ6IEZuLmltcG9ydFZhbHVlKCdtbG9wc0RhdGFCdWNrZXQnKSxcbiAgICBnZ1Byb3BzOiB7XG4gICAgICB0aGluZ0lvdFBvbGljeU5hbWU6IGNvbmZpZ1lhbWxbJ2dnJ11bJ3RoaW5nSW90UG9saWN5TmFtZSddLFxuICAgICAgdG9rZW5FeGNoYW5nZVJvbGVBbGlhczogY29uZmlnWWFtbFsnZ2cnXVsndG9rZW5FeGNoYW5nZVJvbGVBbGlhcyddLFxuICAgICAgYWxsb3dBc3N1bWVUb2tlbkV4Y2hhbmdlUm9sZVBvbGljeU5hbWU6IGNvbmZpZ1lhbWxbJ2dnJ11bJ2FsbG93QXNzdW1lVG9rZW5FeGNoYW5nZVJvbGVQb2xpY3lOYW1lJ10sXG4gICAgICBpb3RUaGluZ05hbWU6IGNvbmZpZ1lhbWxbJ2dnJ11bJ2lvdFRoaW5nTmFtZSddXG4gICAgfSxcbiAgICBkZXBsb3ltZW50UHJvcHM6IHtcbiAgICAgIHNtTW9kZWxQYWNrYWdlR3JvdXBOYW1lOiBGbi5pbXBvcnRWYWx1ZSgnbWxvcHNNb2RlbFBhY2thZ2VHcm91cCcpLFxuICAgICAgZ2dNb2RlbENvbXBvbmVudE5hbWU6IGNvbmZpZ1lhbWxbJ2VkZ2VEZXBsb3ltZW50T3JjaGVzdHJhdGlvbiddWydnZ01vZGVsQ29tcG9uZW50TmFtZSddLFxuICAgICAgZ2dJbmZlcmVuY2VDb21wb25lbnROYW1lOiBjb25maWdZYW1sWydlZGdlRGVwbG95bWVudE9yY2hlc3RyYXRpb24nXVsnZ2dJbmZlcmVuY2VDb21wb25lbnROYW1lJ11cbiAgICB9XG4gIH1cbiAgcmV0dXJuIGFwcENvbmZpZztcbn1cblxuYXN5bmMgZnVuY3Rpb24gTWFpbigpIHtcblxuICBjb25zdCBzdGFjayA9IG5ldyBJbmZlcmVuY2VDZGtQaXBlbGluZShhcHAsICdNTE9wcy1JbmZlcmVuY2UtSW5mcmEtU3RhY2snLCBnZXRDb25maWcoKSk7XG5cbiAgYWRkU2VjdXJpdHlDaGVja3MoYXBwLFtzdGFja10pXG4gIGFwcC5zeW50aCgpO1xufVxuXG5cbmZ1bmN0aW9uIGFkZFNlY3VyaXR5Q2hlY2tzKGFwcDpBcHAsIHN0YWNrczogU3RhY2tbXSl7XG4gIGZvciAobGV0IHN0YWNrIGluIHN0YWNrcykge1xuICAgIE5hZ1N1cHByZXNzaW9ucy5hZGRTdGFja1N1cHByZXNzaW9ucyhzdGFja3Nbc3RhY2tdLFt7aWQ6IFwiQXdzU29sdXRpb25zLUlBTTRcIiwgcmVhc29uOiBcIlN1cHByZXNzIGRpc2FsbG93ZWQgdXNlIG9mIG1hbmFnZWQgcG9saWNpZXMgZm9yIGluY3JlYXNlZCBzaW1wbGljaXR5IGFzIHRoaXMgaXMgYSBzYW1wbGUuIFNjb3BlIGRvd24gaW4gcHJvZHVjdGlvbiFcIiB9XSlcbiAgICBOYWdTdXBwcmVzc2lvbnMuYWRkU3RhY2tTdXBwcmVzc2lvbnMoc3RhY2tzW3N0YWNrXSxbe2lkOiBcIkF3c1NvbHV0aW9ucy1JQU01XCIsIHJlYXNvbjogXCJTdXBwcmVzcyBkaXNhbGxvd2VkIHVzZSBvZiB3aWxkY2FyZHMgaW4gSUFNIHBvbGljaWVzIGZvciBpbmNyZWFzZWQgc2ltcGxpY2l0eSBhcyB0aGlzIGlzIGEgc2FtcGxlLiBTY29wZSBkb3duIGluIHByb2R1Y3Rpb24hXCIgfV0pXG4gICAgTmFnU3VwcHJlc3Npb25zLmFkZFN0YWNrU3VwcHJlc3Npb25zKHN0YWNrc1tzdGFja10sW3tpZDogXCJBd3NTb2x1dGlvbnMtTDFcIiwgcmVhc29uOiBcIlVzaW5nIGZpeGVkIHB5dGhvbiB2ZXJzaW9uIGZvciBsYW1iZGEgZnVuY3Rpb25zIGFzIHNhbXBsZSBuZWVkcyB0byBiZSBzdGFibGVcIiB9XSlcbiAgICBOYWdTdXBwcmVzc2lvbnMuYWRkU3RhY2tTdXBwcmVzc2lvbnMoc3RhY2tzW3N0YWNrXSxbe2lkOiBcIkF3c1NvbHV0aW9ucy1DQjNcIiwgcmVhc29uOiBcIlN1cHByZXNzIHdhcm5pbmcgZm9yIHVzZSBvZiBwcml2aWxlZ2VkIG1vZGUgZm9yIGNvZGVidWlsZCwgYXMgdGhpcyBpcyByZXF1aXJlZCBmb3IgZG9ja2VyIGltYWdlIGJ1aWxkXCIgfV0pXG4gICAgTmFnU3VwcHJlc3Npb25zLmFkZFN0YWNrU3VwcHJlc3Npb25zKHN0YWNrc1tzdGFja10sW3tpZDogXCJBd3NTb2x1dGlvbnMtQ0I0XCIsIHJlYXNvbjogXCJTdXBwcmVzcyByZXF1aXJlZCB1c2Ugb2YgS01TIGZvciBDb2RlQnVpbGQgYXMgaXQgaW5jdXJzIGFkZGl0aW9uYWwgY29zdC4gQ29uc2lkZXIgdXNpbmcgS01TIGZvciBDb2RlYnVpbGQgaW4gcHJvZHVjdGlvblwiIH1dKVxuICB9XG4gIEFzcGVjdHMub2YoYXBwKS5hZGQobmV3IEF3c1NvbHV0aW9uc0NoZWNrcyh7dmVyYm9zZTp0cnVlfSkpO1xuXG59XG5NYWluKCk7XG5cbiJdfQ==